<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meeting Dashboard</title>
  <style>
    /* === GLASSMORPHIC THEME CSS === */
    body {
      min-height: 100vh;
      background: linear-gradient(120deg, #222354 0%, #1b1c2e 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #e0e5fa;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    /* Main Container */
    .dashboard-container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px 20px 20px;
      box-sizing: border-box;
    }

    /* Header Section - Full Width */
    .dashboard-header-container {
      width: 100vw;
      position: relative;
      left: 50%;
      right: 50%;
      margin-left: -50vw;
      margin-right: -50vw;
      background: rgba(54, 61, 114, 0.55);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }

    .dashboard-header {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
    }

    .dashboard-title {
      flex: 1;
    }

    h1 {
      color: #BAA8F0;
      font-size: 2.2rem;
      font-weight: 800;
      margin: 0 0 0.2em 0;
      text-align: left;
      text-shadow: 0 2px 12px rgba(130, 105, 250, 0.10);
    }

    .dashboard-subtitle {
      color: #c7d1f7;
      font-size: 1rem;
      margin: 0;
      text-align: left;
    }

    .header-actions {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    /* Stats Section */
    .stats-section {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      width: 100%;
    }

    .stat-card {
      background: rgba(54, 61, 114, 0.55);
      border-radius: 16px;
      padding: 20px;
      flex: 1;
      text-align: left;
      box-shadow: 0 3.5px 18px 0 #221d4533;
      border: 1px solid rgba(130, 130, 255, 0.09);
    }

    .stat-card h3 {
      color: #b3bfff;
      font-size: 1rem;
      margin: 0 0 10px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .stat-card .value {
      font-size: 2rem;
      font-weight: 700;
      color: #e7d8ff;
      margin: 0;
    }

    /* Filters Section */
    .filters-section {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
    }

    .filter-item {
      background: rgba(54, 61, 114, 0.35);
      border-radius: 20px;
      padding: 8px 16px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .filter-item:hover, .filter-item.active {
      background: rgba(85, 95, 135, 0.5);
    }

    /* Meetings List */
    .meetings-list {
      width: 100%;
    }

    .meeting-card {
      background: rgba(54, 61, 114, 0.55);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 3.5px 18px 0 #221d4533;
      border: 1px solid rgba(130, 130, 255, 0.09);
    }

    .meeting-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .meeting-title {
      color: #e7d8ff;
      font-size: 1.4rem;
      font-weight: 700;
      margin: 0;
    }

    .meeting-status {
      padding: 4px 12px;
      border-radius: 14px;
      font-weight: 700;
      font-size: 0.9rem;
      background: #735bf922;
      color: #bea2fc;
      box-shadow: 0 1px 7px #b39bfc40 inset;
    }

    .meeting-status.past {
      background: #2eeab11b;
      color: #86f9c6;
    }

    .meeting-description {
      color: #bebae7;
      margin: 0 0 15px 0;
      font-size: 1.05rem;
    }

    .meeting-meta {
      display: flex;
      gap: 25px;
      color: #b3bfff;
      margin-bottom: 15px;
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .participants-section {
      margin-top: 15px;
    }

    .participants-label {
      color: #b3bfff;
      font-weight: 600;
      margin-bottom: 8px;
      display: block;
    }

    .participants-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .participant-email {
      color: #b3bfff;
      text-decoration: none;
      padding: 5px 10px;
      background: rgba(85, 95, 135, 0.3);
      border-radius: 12px;
      display: inline-block;
    }

    .participant-email:hover {
      color: #e7d8ff;
      background: rgba(85, 95, 135, 0.5);
    }

    .divider {
      height: 1px;
      background: rgba(130, 130, 255, 0.15);
      margin: 25px 0;
    }

    /* Buttons */
    .btn {
      padding: 10px 20px;
      border-radius: 20px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: linear-gradient(87deg, #8569F9 20%, #44e7e7 95%);
      color: #fff;
      box-shadow: 0 3px 20px 0 #7d59fa29;
    }

    .btn-primary:hover {
      background: linear-gradient(90deg, #6b82E9, #22e7c9 87%);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: linear-gradient(100deg, #6f71ff, #886afd 60%);
      color: #fff;
      box-shadow: 0 2px 16px 0 #857cdf14;
    }

    .btn-secondary:hover {
      background: linear-gradient(100deg, #8e3af3, #685DDF 60%);
      transform: translateY(-2px);
    }

    /* Meeting Form - Centered */
    #meetingForm {
      display: none;
      background: rgba(40, 44, 92, 0.55);
      border-radius: 16px;
      padding: 25px;
      margin: 20px auto;
      box-shadow: 0 8px 28px 0 rgba(70, 85, 180, 0.09);
      border: 1px solid rgba(130, 130, 255, 0.07);
      max-width: 600px;
      position: relative;
    }

    #meetingForm h2 {
      color: #dabaf0;
      font-weight: 700;
      font-size: 1.5rem;
      margin: 0 0 25px 0;
      text-align: center;
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-group label {
      display: block;
      color: #b3bfff;
      margin-bottom: 10px;
      font-weight: 500;
    }

    #meetingForm input,
    #meetingForm textarea {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: none;
      background: rgba(85, 95, 135, 0.38);
      color: #e3e7fd;
      box-sizing: border-box;
      font-size: 1rem;
    }

    #meetingForm input::placeholder,
    #meetingForm textarea::placeholder {
      color: #bcb8d1;
      opacity: 0.7;
    }

    #meetingForm textarea {
      min-height: 100px;
      resize: vertical;
    }

    .datetime-group {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
    }

    .datetime-item {
      flex: 1;
    }

    .datetime-item label {
      display: block;
      color: #b3bfff;
      margin-bottom: 10px;
      font-weight: 500;
    }

    .participants-container {
      margin-bottom: 25px;
    }

    .participants-container label {
      display: block;
      color: #b3bfff;
      margin-bottom: 10px;
      font-weight: 500;
    }

    .participant-input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .participant-input {
      flex: 1;
    }

    .add-participant-btn {
      background: rgba(85, 95, 135, 0.3);
      color: #b3bfff;
      border: none;
      border-radius: 8px;
      padding: 10px 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      transition: background 0.2s;
      width: 100%;
      margin: 15px 0 30px 0;
    }

    .add-participant-btn:hover {
      background: rgba(85, 95, 135, 0.5);
    }

    .form-actions {
      display: flex;
      justify-content: space-between;
      gap: 15px;
      margin-top: 10px;
    }

    /* Center the "Add Another Participant" button text */
    .add-participant-btn span {
      margin-right: 5px;
    }

    /* Hide other content when form is open */
    .hide-when-form-open {
      transition: opacity 0.3s;
    }

    .form-open .hide-when-form-open {
      opacity: 0;
      pointer-events: none;
      height: 0;
      overflow: hidden;
      margin: 0;
      padding: 0;
    }

    /* Icons */
    .icon {
      font-size: 1.2rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .dashboard-header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
      }
      
      .header-actions {
        width: 100%;
        justify-content: flex-end;
      }
      
      .stats-section {
        flex-direction: column;
      }
      
      .meeting-meta {
        flex-direction: column;
        gap: 10px;
      }

      .datetime-group {
        flex-direction: column;
        gap: 10px;
      }

      .form-actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <!-- Full-Width Header Container -->
  <div class="dashboard-header-container hide-when-form-open">
    <div class="dashboard-header">
      <div class="dashboard-title">
        <h1>Meeting Dashboard</h1>
        <p class="dashboard-subtitle">Manage your meetings and stay organized</p>
      </div>
      <div class="header-actions">
        <button id="showMeetingForm" class="btn btn-primary">+ New Meeting</button>
        <button id="logoutBtn" class="btn btn-secondary">Logout</button>
      </div>
    </div>
  </div>

  <div class="dashboard-container">
    <!-- Stats Section -->
    <div class="stats-section hide-when-form-open">
      <div class="stat-card">
        <h3><span class="icon">üìÖ</span> Total Meetings</h3>
        <div class="value" id="totalMeetings">2</div>
      </div>
      <div class="stat-card">
        <h3><span class="icon">‚è∞</span> Upcoming</h3>
        <div class="value" id="upcomingMeetings">0</div>
      </div>
      <div class="stat-card">
        <h3><span class="icon">üë•</span> Completed</h3>
        <div class="value" id="completedMeetings">2</div>
      </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section hide-when-form-open">
      <div class="filter-item active" data-filter="all">All</div>
      <div class="filter-item" data-filter="upcoming">Upcoming</div>
      <div class="filter-item" data-filter="past">Past</div>
    </div>

    <!-- Centered Meeting Form -->
    <div id="meetingForm" aria-live="polite" aria-hidden="true" role="region">
      <h2>Create New Meeting</h2>
      
      <div class="form-group">
        <label for="title">Meeting Title</label>
        <input id="title" placeholder="e.g., Weekly Team Standup" required aria-required="true" />
      </div>
      
      <div class="form-group">
        <label for="desc">Description</label>
        <textarea id="desc" placeholder="Add meeting agenda, goals, or any important notes..."></textarea>
      </div>
      
      <div class="datetime-group">
        <div class="datetime-item">
          <label for="date">üìÖ Date</label>
          <input type="date" id="date" required aria-required="true" />
        </div>
        <div class="datetime-item">
          <label for="time">‚è∞ Time</label>
          <input type="time" id="time" required aria-required="true" />
        </div>
      </div>
      
      <div class="participants-container">
        <label>Participants</label>
        <div id="participantsList">
          <div class="participant-input-group">
            <input type="email" class="participant-input" placeholder="participant@example.com" />
            <button type="button" class="remove-participant-btn btn-secondary" style="padding: 0 10px;">√ó</button>
          </div>
        </div>
        <button type="button" id="addParticipantBtn" class="add-participant-btn">
          <span>+</span> Add Another Participant
        </button>
      </div>
      
      <div class="form-actions">
        <button id="createMeetingBtn" class="btn btn-primary" type="button">Create Meeting</button>
        <button id="cancelCreate" class="btn btn-secondary" type="button">Cancel</button>
      </div>
    </div>

    <!-- Meetings List -->
    <div class="meetings-list hide-when-form-open" id="meetingsContainer">
      <!-- Meeting cards will be dynamically inserted here -->
    </div>

    <div class="divider hide-when-form-open"></div>

    <div id="newMeetingContainer" class="hide-when-form-open">
      <!-- New meetings will be added here -->
    </div>
  </div>

  <script>
    // Redirect to login if no token
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'login-signup.html';
    }

    // Toggle form visibility and hide other content
    function toggleFormVisibility(show) {
      const form = document.getElementById('meetingForm');
      if (show) {
        document.body.classList.add('form-open');
        form.style.display = 'block';
        form.setAttribute('aria-hidden', 'false');
        document.getElementById('title').focus();
      } else {
        document.body.classList.remove('form-open');
        form.style.display = 'none';
        form.setAttribute('aria-hidden', 'true');
      }
    }

    // Show and hide meeting form
    document.getElementById('showMeetingForm').onclick = () => {
      toggleFormVisibility(true);
    };

    document.getElementById('cancelCreate').onclick = () => {
      toggleFormVisibility(false);
      clearForm();
    };

    // Add participant input field
    document.getElementById('addParticipantBtn').addEventListener('click', () => {
      const participantsList = document.getElementById('participantsList');
      const newParticipantGroup = document.createElement('div');
      newParticipantGroup.className = 'participant-input-group';
      newParticipantGroup.innerHTML = `
        <input type="email" class="participant-input" placeholder="participant@example.com" />
        <button type="button" class="remove-participant-btn btn-secondary" style="padding: 0 10px;">√ó</button>
      `;
      participantsList.appendChild(newParticipantGroup);
      
      // Add event listener to new remove button
      newParticipantGroup.querySelector('.remove-participant-btn').addEventListener('click', function() {
        participantsList.removeChild(newParticipantGroup);
      });
    });

    // Clear form fields
    function clearForm() {
      document.getElementById('title').value = '';
      document.getElementById('desc').value = '';
      document.getElementById('date').value = '';
      document.getElementById('time').value = '';
      
      const participantsList = document.getElementById('participantsList');
      participantsList.innerHTML = `
        <div class="participant-input-group">
          <input type="email" class="participant-input" placeholder="participant@example.com" />
          <button type="button" class="remove-participant-btn btn-secondary" style="padding: 0 10px;">√ó</button>
        </div>
      `;
    }

    // Create meeting API call
    document.getElementById('createMeetingBtn').onclick = async () => {
      const title = document.getElementById('title').value.trim();
      const description = document.getElementById('desc').value.trim();
      const date = document.getElementById('date').value;
      const time = document.getElementById('time').value;
      
      if (!title || !date || !time) {
        alert('Please fill all required fields.');
        return;
      }
      
      // Combine date and time
      const datetime = `${date}T${time}`;
      
      // Get all participant emails
      const participantInputs = document.querySelectorAll('.participant-input');
      const participants = Array.from(participantInputs)
        .map(input => input.value.trim())
        .filter(email => email.length > 0);

      if (participants.length === 0) {
        alert('Please enter at least one participant email.');
        return;
      }

      try {
        const res = await fetch('/api/meetings', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token,
          },
          body: JSON.stringify({ title, description, datetime, participants }),
        });

        if (!res.ok) {
          const errorData = await res.json();
          throw new Error(errorData.error || 'Failed to create meeting');
        }

        alert('Meeting created successfully!');
        toggleFormVisibility(false);
        clearForm();
        fetchMeetings(); // Refresh list
      } catch (err) {
        alert(err.message || 'Error occurred while creating meeting');
      }
    };

    // Fetch meetings for logged-in user with filter support
    async function fetchMeetings() {
      try {
        const activeFilter = document.querySelector('.filter-item.active')?.dataset.filter || 'all';
        const response = await fetch(`/api/meetings?filter=${activeFilter}`, {
          headers: {
            'Authorization': 'Bearer ' + token,
          },
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to fetch meetings');
        }
        
        const meetings = await response.json();
        renderMeetings(meetings);
        updateStats(meetings);
      } catch (err) {
        console.error('Error loading meetings:', err);
        alert(err.message || 'Error loading meetings. Please try again.');
        if (err.message.includes('token') || err.message.includes('auth')) {
          localStorage.removeItem('token');
          window.location.href = 'login-signup.html';
        }
      }
    }

    // Update statistics
    function updateStats(meetings) {
      const now = new Date();
      const upcoming = meetings.filter(m => new Date(m.datetime) > now).length;
      const completed = meetings.filter(m => new Date(m.datetime) <= now).length;
      
      document.getElementById('totalMeetings').textContent = meetings.length;
      document.getElementById('upcomingMeetings').textContent = upcoming;
      document.getElementById('completedMeetings').textContent = completed;
    }

    // Render meetings dynamically
    function renderMeetings(meetings) {
      const container = document.getElementById('meetingsContainer');
      container.innerHTML = '';

      if (!meetings.length) {
        container.innerHTML = '<p style="color:#999; font-size:1.2rem;">No meetings found matching your filter.</p>';
        return;
      }

      meetings.forEach(meeting => {
        const dateObj = new Date(meeting.datetime);
        const isPast = dateObj < new Date();
        const formattedDate = dateObj.toLocaleDateString('en-US', { 
          weekday: 'short', 
          year: 'numeric', 
          month: 'short', 
          day: 'numeric' 
        });
        const formattedTime = dateObj.toLocaleTimeString([], { 
          hour: '2-digit', 
          minute: '2-digit' 
        });

        const meetingEl = document.createElement('div');
        meetingEl.className = 'meeting-card';

        // Create participants list HTML
        let participantsHTML = '';
        meeting.participants.forEach(email => {
          participantsHTML += `<a href="mailto:${email}" class="participant-email">${email}</a>`;
        });

        meetingEl.innerHTML = `
          <div class="meeting-header">
            <h3 class="meeting-title">${escapeHTML(meeting.title)}</h3>
            <div class="meeting-status ${isPast ? 'past' : 'upcoming'}">${isPast ? 'Completed' : 'Upcoming'}</div>
          </div>
          ${meeting.description ? `<p class="meeting-description">${escapeHTML(meeting.description)}</p>` : ''}
          <div class="meeting-meta">
            <div class="meta-item">
              <span class="icon">üìÖ</span>
              <span>${formattedDate}</span>
            </div>
            <div class="meta-item">
              <span class="icon">‚è∞</span>
              <span>${formattedTime}</span>
            </div>
            <div class="meta-item">
              <span class="icon">üë•</span>
              <span>${meeting.participants.length} participant${meeting.participants.length !== 1 ? 's' : ''}</span>
            </div>
          </div>
          <div class="participants-section">
            <span class="participants-label">Participants:</span>
            <div class="participants-list">
              ${participantsHTML}
            </div>
          </div>
        `;

        container.appendChild(meetingEl);
      });
    }

    // Simple sanitizer to avoid XSS
    function escapeHTML(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initial load
    fetchMeetings();

    // Logout button clears token and redirects
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('token');
      window.location.href = 'login-signup.html';
    });

    // Status filter functionality
    document.querySelectorAll('.filter-item').forEach(filter => {
      filter.addEventListener('click', function() {
        document.querySelectorAll('.filter-item').forEach(f => f.classList.remove('active'));
        this.classList.add('active');
        fetchMeetings();
      });
    });
  </script>
</body>
</html>